---
title: "Sample Size Calculation for Trials with 3 arms and 3 endpoints"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Sample Size Calculation for Trials with 3 arms and 3 endpoints}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: '`r system.file("references.bib", package="simsamplesize")`'
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

It is often required to investigate equivalence for more than one primary variable. For example, EMA recommends showing equivalence both for AUC and Cmax 

A decision must be made as to whether it is desirable to 
Demonstrate equivalence for all primary endpoints : most common setting(also known as “multiple co-primary endpoints”)
Demonstrate equivalence for at least one of the primary endpoints(also known as “multiple primary endpoints”)



# Example data
As an illustrative example, we consider published data from the phase-1 trial [NCT01922336](https://clinicaltrials.gov/study/NCT01922336#study-overview). In this trial, the following outcomes were observed after a single dose of SB2 or its EU-sourced reference product [@shin_randomized_2015]:

```{r setup, echo=FALSE}

data <- data.frame("PK measure" = c("AUCinf ($\\mu$g*h/mL)","AUClast ($\\mu$g*h/mL)","Cmax ($\\mu$g/mL)"),
                   "SB2" = c("38,703 $\\pm$ 11,114", "36,862 $\\pm$ 9133", "127.0 $\\pm$ 16.9"), 
                   "EU-INF" = c("39,360  $\\pm$ 12,332", "37,022 $\\pm$ 9398", "126.2 $\\pm$ 17.9"),
                   "US-INF" = c("39,270 $\\pm$ 10,064", "37,368 $\\pm$ 8332", "129.2 $\\pm$ 18.8"))

kableExtra::kable_styling(kableExtra::kable(data, 
                                            col.names = c("PK measure", "SB2", "EU-INF", "US-INF"),
                                            caption = "Primary PK measures between test and reference product. Data represent arithmetic mean +- standard deviation."),
                          bootstrap_options = "striped")

```

Just like in [this vignette](three_ep_two_arms.html), we need to provide information of the mean (`mu_list`), standard deviation for each endpoint and arm (`sigma_list`), endpoint and arm names (`yname_list` and `arm_names`),  arms to be compared within each comparator (`list_comparator`), and endpoints to be compared within each comparator (`list_y_comparator`). We will compare each biosimilar simultaneously, i.e., SB2 vs EU Remicade and SB2 vs US Remicade.

```{r}
mu_list <- list(SB2 = c(AUCinf = 38703, AUClast = 36862, Cmax = 127.0),
                EUREF = c(AUCinf = 39360, AUClast = 37022, Cmax = 126.2),
                USREF = c(AUCinf = 39270, AUClast = 37368, Cmax = 129.2))

sigma_list <- list(SB2 = c(AUCinf = 11114, AUClast = 9133, Cmax = 16.9),
                   EUREF = c(AUCinf = 12332, AUClast = 9398, Cmax = 17.9),
                   USREF = c(AUCinf = 10064, AUClast = 8332, Cmax = 18.8))

# Equivalence boundaries
lequi.tol <- c(AUCinf = 0.8, AUClast = 0.8, Cmax = 0.8)
uequi.tol <- c(AUCinf = 1.25, AUClast = 1.25, Cmax = 1.25)
```

# Testing the Ratio of Means (ROM) for multiple Co-primary Endpoints

## Different Hypotheses across endpoints
In this example, we would like to demonstrate bio-equivalence of SB2 versus EU-INF (w.r.t. AUCinf and Cmax), and bio-equivalence of SB2 versus US-INF (w.r.t. AUClast and Cmax). For all endpoints, we require that the 90\% confidence intervals for the ratios of the geometric means fall within the range of 80.00\% to 125.00\%.

```{r}

library(simsamplesize)

 # arms to be compared
list_comparator <- list(EMA = c("SB2", "EUREF"),
                        FDA = c("SB2", "USREF"))

# endpoint to be compared
list_y_comparator <- list(EMA = c("AUCinf", "Cmax"),
                          FDA = c("AUClast", "Cmax"))


    
    
result <- calopt(power = 0.9, # target power
                 alpha = 0.05,
                 mu_list = mu_list,
                 sigma_list = sigma_list,
                 lequi.tol = lequi.tol,
                 uequi.tol = uequi.tol,
                 list_comparator = list_comparator,
                 list_y_comparator = list_y_comparator,
                 adjust = "no",
                 dtype = "parallel",
                 ctype = "ROM",
                 vareq = TRUE,
                 lognorm = TRUE,
                 ncores = 1,
                 nsim = 50, 
                 seed = 1234)
result
```
When we increase `nsim` to 10000, we find a total sample size of $N=120$ patients (40 per arm).


# Testing the Ratio of Means (ROM) for multiple primary endpoints

## Equivalence for At Least 2 of the 3 Endpoints with Bonferroni Adjustment


In this example, we assume the equality of variance (`vareq = TRUE`), Ratio of Means (ROM) as parameter tested (`ctype = "ROM"`), parallel design (`dtype = "parallel"`), lognormal distribution (`lognorm = TRUE`), no correlation between endpoints (default value of the function is `rho = 0`, and bonferroni multiplicity adjustment will be made (`adjust = "bon"`). Also, equivalence is only needed for two of the three endpoints (`k=2`).  


```{r}
library(simsamplesize)
output_1 <- calopt(power = 0.9, # target power
                   alpha = 0.05,
                   mu_list = mu_list,
                   sigma_list = sigma_list,
                   lequi.tol = lequi.tol,
                   uequi.tol = uequi.tol,
                   k = 2,
                   adjust="bon",
                   ncores = 1,
                   nsim = 50, 
                   seed = 1234)
print(output_1$response)
```

Based on the table above, the sample size required for each arm is `r output_1$response$n_SB2`. In total, we need `r output_1$response$n_total` samples for this trial setting. 

## Different allocation rate on each arm 

In this example, the setting is the same with the previous example. However, here, we need to specify a different allocation rate on each arm. Particularly we require that the number of patients in the new treatment would be the double of the patients on the reference arms. This can be easily set on the treatment allocation rate parameter (`TAR`), where rates are included in a vector `TAR=c(2,1,1)`.  

```{r}
#specify TAR=c(2,1,1)
output_2 <- calopt(power = 0.9, # target power
                   alpha = 0.05,
                   mu_list = mu_list,
                   sigma_list = sigma_list,
                   lequi.tol = lequi.tol,
                   uequi.tol = uequi.tol,
                   k = 2,
                   adjust="bon",
                   TAR=c(2,1,1),
                   ncores = 1,
                   nsim = 50)

print(output_2$response)
```

Based on the table above, `r output_2$response$n_SB2` samples are required for SB2 the new treatment arm, which is double the required number for the reference arms in this trial setting as it was specified in the TAR parameter. The total sample size required for this setting is `r output_2$response$n_total`. This number is significantly larger compared to the previous example.

## Dropout considerations

In the examples above, we have only considered for the sample size calculation that all patients included in the trial complete the trial. However, in practice it is generally expected that a percentage of the patients will drop out of the trial, which could affect the expected sample size. In this case, we considered that a 20% dropout rate is expected in all arms.


```{r}
#specify expected dropout of 10% on all the arms.
output_3 <- calopt(power = 0.9, # target power
                   alpha = 0.05,
                   mu_list = mu_list,
                   sigma_list = sigma_list,
                   lequi.tol = lequi.tol,
                   uequi.tol = uequi.tol,
                   k = 2,
                   adjust="bon",
                   TAR=c(2,1,1),
                   dropout = 0.2,
                   ncores = 1,
                   nsim = 50)
print(output_3$response)
```
Based on the output above, considering 20% dropout rate, the number of sample size required is `r output_3$response$n_total`.


## Different Lower and Upper Equivalence Margin across endpoints

In this example, we will calculate the sample size as in we do in the previous example. The difference lies on the lower and upper equivalence margin that is specified for each of the endpoints. Hence, all we need to do is to modify `lequi.tol` and `uequi.tol`.

```{r}
lequi.tol <- c(0.8,0.9,0.7)
uequi.tol <- c(1/0.8,1/0.9,1/0.7)
```

After the modification, we can proceed to calculate the sample size.

```{r }
output_4 <- calopt(power = 0.9, # target power
                   alpha = 0.05,
                   mu_list = mu_list,
                   sigma_list = sigma_list,
                   lequi.tol = lequi.tol,
                   uequi.tol = uequi.tol,
                   k = 2,
                   adjust="bon",
                   TAR=c(1,1,1),
                   ncores = 1,
                   nsim = 50)
print(output_4$response)
```
Based on the output above, the number of sample size required, with the assumption of different equivalence tolerance, is `r output_4$response$n_total`. 

Further, using this example, we can make a plot of sample size (x-axis) vs power obtained (y-axis) for each of comparison. We can do this using `plot.simss()`. This function takes the object of simulation resulted from `calopt()` function.


```{r, fig.height=4, fig.width = 10, out.width = "95%"}
plot.simss(output_4)
```


# References
