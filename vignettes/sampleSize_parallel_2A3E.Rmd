---
title: "Bioequivalence Tests for Parallel Trial Designs: 2 Arms, 3 Endpoints"
author: "Thomas Debray"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    fig_caption: yes
    fig_width: 9
    fig_height: 6
vignette: >
  %\VignetteIndexEntry{Bioequivalence Tests for Parallel Trial Designs: 2 Arms, 3 Endpoints}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: 'references.bib'
link-citations: yes
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(comment = "#>", collapse = TRUE)
options(rmarkdown.html_vignette.check_title = FALSE) #title of doc does not match vignette title
doc.cache <- T #for cran; change to F
```

# Introduction

In many studies, it is necessary to evaluate equivalence across multiple primary variables. For instance, the European Medicines Agency (EMA) recommends demonstrating equivalence for both **Area Under the Curve** (AUC) and **maximum concentration** (Cmax) when assessing pharmacokinetic properties.

When multiple primary endpoints are involved, a decision must be made on the desired criteria for equivalence:

* Equivalence for All Primary Endpoints
  * This is the most common setting and is often referred to as having *multiple co-primary endpoints*.
  * Equivalence must be demonstrated for **all** endpoints to conclude overall equivalence.
* Equivalence for At Least One Primary Endpoint
  * Known as having *multiple primary endpoints*.
  * Equivalence is required for **at least one** endpoint to meet the study's objectives.

This vignette presents advanced techniques for calculating sample size in parallel trial designs involving three treatment arms and two endpoints. Specifically, it focuses on bioequivalence testing between a new treatment (SB2) and a reference drug (Remicade) administered in two distinct locations (EU_Remicade and USA_Remicade).

As an illustrative example, we consider published data from the phase-1 trial [NCT01922336](https://clinicaltrials.gov/study/NCT01922336#study-overview). This trial assessed the pharmacokinetics of SB2 compared to its EU-sourced reference product. The following outcomes were reported following a single dose of SB2 or its EU reference product [@shin_randomized_2015]:

```{r, echo=FALSE}
data <- data.frame("PK measure" = c("AUCinf ($\\mu$g*h/mL)","AUClast ($\\mu$g*h/mL)","Cmax ($\\mu$g/mL)"),
                   "SB2" = c("38,703 $\\pm$ 11,114", "36,862 $\\pm$ 9133", "127.0 $\\pm$ 16.9"), 
                   "EU-INF" = c("39,360  $\\pm$ 12,332", "37,022 $\\pm$ 9398", "126.2 $\\pm$ 17.9"))

kableExtra::kable_styling(kableExtra::kable(data, 
                                            col.names = c("PK measure", "SB2", "Remicade (EU)"),
                                            caption = "Primary PK measures between test and reference product. Data represent arithmetic mean +- standard deviation."),
                          bootstrap_options = "striped")
```

# Methodology and Assumptions

The bioequivalence analysis focuses on two key pharmacokinetic endpoints:

* AUCinf: Area Under the Curve (infinity)
* Cmax: Maximum concentration

For both endpoints, the analysis assumes that:

* Summary data (e.g., mean and standard deviation) are available on the original scale.
* These data are provided for each treatment arm.

To evaluate bioequivalence, we apply the $80\%/125\%$ rule, which defines equivalence bounds relative to the reference mean. The evaluation is conducted using a one-sided significance level of 5\%, with a target statistical power of 90\%.


## Hypotheses
The null and alternative hypotheses for the equivalence test are as follows:

### Difference of Means (DOM)

Null Hypothesis ($H_0$): At least one endpoint does not meet the equivalence criteria:
 
$$H_0: \mu_T^{(j)} - \mu_R^{(j)} \le E_L ~~ \text{or}~~ \mu_T^{(j)} - \mu_R^{(j)} \ge E_U \quad \text{for at least one}\;j$$

Alternative Hypothesis ($H_1$): All endpoints meet the equivalence criteria:

$$H_1: E_L<\mu_{T}^{(j)}-\mu_{R}^{(j)} < E_U \quad\text{for all}\;j$$

The null hypothesis ($H_0$) is rejected if, and only if, all null hypotheses associated with the $K$ primary endpoints are rejected at a significance level of $\alpha$. This ensures that equivalence is established across all endpoints simultaneously. 

### Ratio of Means (ROM)
The equivalence hypotheses can also be expressed as a Ratio of Means (ROM), which is often used in bioequivalence studies:

Null Hypothesis ($H_0$): At least one endpoint does not meet the equivalence criteria:
 
$$H_0: \frac{\mu_T^{(j)}}{\mu_R^{(j)}} \le \log(E_L) ~~ \text{or}~~ \frac{\mu_T^{(j)}}{\mu_R^{(j)}} \ge \log(E_U) \quad \text{for at least one}\;j$$

Alternative Hypothesis ($H_1$): All endpoints meet the equivalence criteria:

$$H_1: \log(E_L)< \frac{\mu_{T}^{(j)}}{\mu_{R}^{(j)}} < \log(E_U) \quad\text{for all}\;j$$


## Statistical Considerations

### Consistency Across Endpoints
For equivalence to be established, all primary endpoints must simultaneously satisfy the equivalence criteria. This applies whether the criteria are expressed as:

  * The Difference of Means (DOM) approach measures absolute differences between treatment means.
  * The Ratio of Means (ROM) approach captures relative differences and is commonly used when analyzing log-transformed data, such as in pharmacokinetic studies.

### Type I Error Control
Rejection of the null hypothesis ($H_0$) requires that all individual null hypotheses across endpoints be rejected. Since the test is designed to achieve equivalence simultaneously for all endpoints, there is no need for multiplicity adjustments, and the Type I error rate is controlled by the study design.

### Impact on Power
Requiring equivalence across multiple endpoints reduces the overall power of the test. Specifically:

* The Type II error increases as the number of primary endpoints ($K$) grows.
* This makes equivalence testing more challenging for studies with multiple endpoints, as additional endpoints require larger sample sizes or stronger effect sizes to achieve sufficient power [@mielke_sample_2018].


## Independent Testing of PK Measures
If each pharmacokinetic (PK) measure is tested independently, the following sample sizes would be required for each endpoint to achieve a 5\% significance level:

```{r}
library(SimTOST)

# Sample size calculation for AUCinf
(sim_AUCinf <- sampleSize(
  power = 0.9,                                # Target power
  alpha = 0.05,                               # Significance level
  arm_names = c("SB2", "EU_Remicade"),        # Names of trial arms
  list_comparator = list("EMA" = c("SB2", "EU_Remicade")),  # Comparator configuration
  mu_list = list("SB2" = 38703, "EU_Remicade" = 39360),     # Mean values
  sigma_list = list("SB2" = 11114, "EU_Remicade" = 12332),  # Standard deviation values
  list_lequi.tol = list("EMA" = 0.80),        # Lower equivalence margin
  list_uequi.tol = list("EMA" = 1.25),        # Upper equivalence margin
  ncores = 1,                                 # Number of computation cores
  nsim = 1000                                 # Number of stochastic simulations
))

# Sample size calculation for AUClast
(sim_AUClast <- sampleSize(
  power = 0.9,                                # Target power
  alpha = 0.05,                               # Significance level
  arm_names = c("SB2", "EU_Remicade"),        # Names of trial arms
  list_comparator = list("EMA" = c("SB2", "EU_Remicade")),  # Comparator configuration
  mu_list = list("SB2" = 36862, "EU_Remicade" = 37022),     # Mean values
  sigma_list = list("SB2" = 9133, "EU_Remicade" = 9398),    # Standard deviation values
  list_lequi.tol = list("EMA" = 0.80),        # Lower equivalence margin
  list_uequi.tol = list("EMA" = 1.25),        # Upper equivalence margin
  ncores = 1,                                 # Number of computation cores
  nsim = 1000                                 # Number of stochastic simulations
))


# Sample size calculation for Cmax
(sim_Cmax <- sampleSize(
  power = 0.9,                                # Target power
  alpha = 0.05,                               # Significance level
  arm_names = c("SB2", "EU_Remicade"),        # Names of trial arms
  list_comparator = list("EMA" = c("SB2", "EU_Remicade")),  # Comparator configuration
  mu_list = list("SB2" = 127.0, "EU_Remicade" = 126.2),     # Mean values
  sigma_list = list("SB2" = 16.9, "EU_Remicade" = 17.9),    # Standard deviation values
  list_lequi.tol = list("EMA" = 0.80),        # Lower equivalence margin
  list_uequi.tol = list("EMA" = 1.25),        # Upper equivalence margin
  ncores = 1,                                 # Number of computation cores
  nsim = 1000                                 # Number of stochastic simulations
))
```

If we were to test each PK measure independently, we would find a total sample size of `r sim_AUCinf$response$n_total` for AUCinf, `r sim_AUClast$response$n_total` for AUClast, and `r sim_Cmax$response$n_total` for Cmax. This means that we would have to enroll `r sim_AUCinf$response$n_total` + `r sim_AUClast$response$n_total` + `r sim_Cmax$response$n_total` = `r sim_AUCinf$response$n_total + sim_AUClast$response$n_total + sim_Cmax$response$n_total` patients in order to reject $H_0$ at a significance level of 5\%. For context, the original trial was a randomized, single-blind, three-arm, parallel-group study conducted in 159 healthy subjects, slightly more than the `r sim_AUCinf$response$n_total + sim_AUClast$response$n_total + sim_Cmax$response$n_total` patients estimated as necessary. This suggests that the original trial had a small buffer above the calculated sample size requirements.

## Simultaneous Testing of PK Measures with Independent Endpoints
This approach focuses on simultaneous testing of pharmacokinetic (PK) measures while assuming independence between endpoints. Unlike the previous approach, which evaluated each PK measure independently, this method integrates comparisons across multiple endpoints, accounting for correlations (or lack thereof) between them. By doing so, it enables simultaneous testing for equivalence without inflating the overall Type I error rate.

In this setting, equivalence is required for at least one endpoint rather than all endpoints, reducing the overall sample size compared to independent testing. Furthermore, this approach allows for greater flexibility by enabling users to specify correlation structures or work with uncorrelated endpoints as a default assumption.





# References
